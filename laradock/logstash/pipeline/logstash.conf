input {
	tcp {
		port => 5044
	}
	file {
        path => "/var/log/nginx/access*.log"
        type => "nginx_access"
		start_position => "beginning"
		sincedb_path => "/dev/null"
    }
    file {
        path => "/var/log/nginx/error*.log"
        type => "nginx_error"
		start_position => "beginning"
		sincedb_path => "/dev/null"
    }
    file {
        path => "/var/log/mysql/error*.log"
        type => "mysql_error"
		start_position => "beginning"
		sincedb_path => "/dev/null"
    }
    file {
        path => "/var/log/php/php_errors.log"
        type => "php_errors"
		start_position => "beginning"
		sincedb_path => "/dev/null"
    }
	file {
        path => "/var/www/storage/logs/laravel-*.log"
        type => "laravel_log"
		start_position => "beginning"
		sincedb_path => "/dev/null"
        codec => multiline {
            pattern => "\[[\d]{4}"
			auto_flush_interval => 10
            what => "previous"
            negate => true
			
        }
    }
}

## Add your filters / logstash plugins configuration here
filter {
    if [type] == "nginx_error" {
          grok {
                match => { "message" => "%{NGINXERROR}" }
                patterns_dir => [ "/etc/logstash/patterns.d" ]
          }
    }
    if [type] == "nginx_access" {
            grok {
                    match => { "message" => "%{NGINXACCESS}" }
            }

            mutate {

                    convert => [ "bytes_received", "integer"]
                    convert => [ "bytes_sent", "integer"]
                    convert => [ "upstream_time", "float"]
                    convert => [ "request_time", "float"]
            }

            date {
                    match => [ "timestamp_nginx_access" , "dd/MMM/YYYY:HH:mm:ss Z" ]
            }
    }
    if [type] == "php_errors" {
        grok {
            match => { "message" => "%{PHPFPMLOG}" }
            patterns_dir => [ "/etc/logstash/patterns.d" ]
        }
    }
	if [type] == "laravel_log" {
        grok {
            match => { "message" => "%{LARAVELLOG}" }
			patterns_dir => [ "/opt/logstash/patterns" ]
        }
	}
}


output {

	if [type] == "laravel_log" {
	elasticsearch {
		hosts => "elasticsearch:9200"
		index => "laravel_log"
	}
  }
  if [type] == "nginx_access" {
	elasticsearch {
		hosts => "elasticsearch:9200"
		index => "nginx_access"
	}
  }
    if [type] == "nginx_error" {
	elasticsearch {
		hosts => "elasticsearch:9200"
		index => "nginx_error"
	}
  }
    if [type] == "php_errors" {
	elasticsearch {
		hosts => "elasticsearch:9200"
		index => "php_errors"
	}
  }
    if [type] == "mysql_error" {
	elasticsearch {
		hosts => "elasticsearch:9200"
		index => "mysql_error"
	}
  }
  
}
